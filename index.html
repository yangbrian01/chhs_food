<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç¤¾åœ˜é»é¤ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3ffec; -webkit-tap-highlight-color: transparent; }
    button { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    .loading-spinner { border-top-color: #34d399; border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 1rem; }
  </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex justify-center items-start">

  <div id="main-container" class="w-full max-w-xl bg-white shadow-2xl rounded-2xl p-6 sm:p-8 space-y-8 ring-4 ring-green-300/50 relative flex flex-col min-h-[80vh]">
    <div class="flex-grow space-y-8">
        <header class="text-center pb-4 border-b border-gray-200">
        <h1 class="text-4xl font-extrabold text-green-700">ğŸœ é¢¨å²¡ç·šä¸Šé»é¤ ğŸ°</h1>
        <p id="user-info-display" class="text-sm mt-2 text-gray-500">è«‹ç™»å…¥æˆ–è¨»å†Šä»¥é–‹å§‹é»é¤</p>
        </header>

        <div id="message-box" class="hidden"></div>
        <div id="loading-overlay" class="hidden fixed inset-0 bg-white/50 z-50 flex justify-center items-center"><div class="loading-spinner border-4 border-gray-300 border-t-green-600 w-12 h-12"></div></div>

        <section id="auth-section" class="space-y-6 pt-4">
        <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-700">ä½¿ç”¨è€…ç™»å…¥</h2>
        <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
            <input type="text" name="username" placeholder="ä¸­æ–‡åå­—" required class="w-full p-3 border border-gray-300 rounded-lg">
            <input type="password" name="password" placeholder="å¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg">
            <button type="submit" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">ç™»å…¥ç³»çµ±</button>
        </form>
        <form id="register-form" onsubmit="handleRegister(event)" class="space-y-4 hidden">
            <input type="text" name="username" placeholder="ä¸­æ–‡åå­—" required class="w-full p-3 border border-gray-300 rounded-lg">
            <input type="password" name="password" placeholder="å¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg">
            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">è¨»å†Šæ–°å¸³è™Ÿ</button>
        </form>
        <p id="auth-toggle-link" class="text-center text-sm text-gray-600 cursor-pointer hover:underline" onclick="toggleAuthMode()"></p>
        </section>

        <section id="order-section" class="space-y-6 hidden">
        <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-700">èœå–®å“é …</h2>
            <div class="flex space-x-2"> 
                <button onclick="showHistoryPage()" class="py-1 px-4 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200">ç´€éŒ„</button>
                <button onclick="handleLogout()" class="py-1 px-4 text-sm bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">ç™»å‡º</button>
                <button id="admin-entry-btn" onclick="showAdminPanel()" class="hidden py-1 px-4 text-sm bg-red-100 text-red-700 rounded-full hover:bg-red-200 ring-2 ring-red-200">ğŸ”§ ç®¡ç†</button>
            </div>
        </div>
        <div id="menu-list" class="space-y-3"></div>
        <div class="pt-6 border-t border-green-200 space-y-4">
            <div id="cart-list" class="space-y-2 border-b pb-4"></div>
            <div class="flex justify-between items-center text-3xl font-extrabold"><span>ç¸½é‡‘é¡:</span><span id="total-price" class="text-red-600">NT$ 0</span></div>
            <button id="submit-button" onclick="submitOrder()" disabled class="w-full py-4 px-4 bg-green-500 text-white font-bold text-lg rounded-xl shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">è«‹é¸æ“‡é¤é»</button>
        </div>
        </section>
        
        <section id="history-section" class="space-y-6 hidden pt-4">
        <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-700">é»é¤è¨˜éŒ„</h2>
            <button onclick="showOrderPage()" class="py-1 px-4 text-sm bg-green-100 text-green-700 rounded-full">è¿”å›</button>
        </div>
        <div id="history-list" class="space-y-4"></div>
        </section>
    </div>

    <section id="admin-section" class="hidden fixed inset-0 w-full h-full bg-gray-100 z-50 flex flex-col">
      <div class="bg-white shadow p-4 flex justify-between items-center z-10">
         <h2 class="text-xl font-bold text-red-700">ğŸ”§ å¾Œå°ç®¡ç†</h2>
         <button onclick="closeAdminPanel()" class="px-4 py-2 bg-gray-200 rounded font-bold">é—œé–‰</button>
      </div>
      <div class="bg-white border-b flex p-2 gap-2 overflow-x-auto">
         <button onclick="switchAdminTab('orders')" class="px-4 py-2 font-bold text-red-600 border-b-2 border-red-600">è¨‚å–®</button>
         <button onclick="switchAdminTab('summary')" class="px-4 py-2 text-gray-500">çµ±è¨ˆ</button>
         <button onclick="switchAdminTab('menu')" class="px-4 py-2 text-gray-500">èœå–®</button>
      </div>
      <div class="flex-grow overflow-y-auto p-4 space-y-4">
         <div id="admin-tab-orders">
            <div class="flex justify-end mb-2"><button onclick="confirmResetOrders()" class="bg-red-600 text-white px-3 py-1 rounded text-sm">âš ï¸ æ¸…ç©ºç´€éŒ„</button></div>
            <div id="admin-order-list" class="space-y-2"></div>
         </div>
         <div id="admin-tab-summary" class="hidden">
            <div class="bg-white p-4 rounded shadow mb-4"><p>ç¸½é‡‘é¡: <span id="admin-grand-total" class="text-2xl font-bold text-green-700"></span></p></div>
            <table class="w-full bg-white rounded shadow"><tbody id="admin-summary-list"></tbody></table>
            <button onclick="captureSummary()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded">æˆªåœ–</button>
            <div id="summary-capture-area" class="hidden bg-white p-4"></div>
         </div>
         <div id="admin-tab-menu" class="hidden space-y-4">
            <div class="bg-white p-4 rounded shadow space-y-2">
               <h3 class="font-bold">æ–°å¢/ä¿®æ”¹</h3>
               <input type="hidden" id="edit-item-id">
               <input id="new-item-name" placeholder="åç¨±" class="border p-2 w-full">
               <input id="new-item-price" type="number" placeholder="åƒ¹æ ¼" class="border p-2 w-full">
               <select id="new-item-type" class="border p-2 w-full"><option value="å–®é»">å–®é»</option><option value="å¥—é¤">å¥—é¤</option></select>
               <button onclick="submitMenuForm()" class="w-full bg-green-600 text-white py-2 rounded font-bold">é€å‡º</button>
               <button onclick="resetMenuForm()" class="w-full bg-gray-200 text-gray-600 py-2 rounded text-sm">é‡ç½®</button>
            </div>
            <div id="admin-menu-list" class="space-y-2"></div>
         </div>
      </div>
    </section>

    <div id="system-modal" class="modal-overlay hidden">
       <div class="bg-white rounded-lg p-6 w-80 text-center space-y-4 shadow-xl">
          <p id="system-modal-msg" class="font-bold text-gray-800"></p>
          <div class="flex gap-2 justify-center">
             <button id="sys-cancel" onclick="document.getElementById('system-modal').classList.add('hidden')" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button>
             <button id="sys-confirm" class="bg-blue-600 text-white px-4 py-2 rounded">ç¢ºå®š</button>
          </div>
       </div>
    </div>

    <div id="options-modal" class="modal-overlay hidden">
       <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto space-y-4">
          <h3 class="text-xl font-bold">é¸æ“‡é¸é …</h3>
          <div id="modal-content" class="space-y-4"></div>
          <div class="flex justify-end gap-2">
             <button onclick="document.getElementById('options-modal').classList.add('hidden')" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button>
             <button onclick="addToCartFromModal()" class="bg-indigo-600 text-white px-4 py-2 rounded">åŠ å…¥</button>
          </div>
       </div>
    </div>
    
    <div id="image-preview-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
        <div class="bg-white p-2 rounded max-w-sm"><img id="preview-img" class="w-full"></div>
    </div>
  </div>

<script>
// ============================================================================
// âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€ (Web App URL)
// ============================================================================
const API_URL = "https://script.google.com/macros/s/AKfycbyAhRNw8OKB6a9tos3Uz5280nOc9w8LBSXtm3amRSFz15RPUFLpqfGtm8F0RhETKxsu/exec"; 

// ===================== æ ¸å¿ƒé€šè¨Š (Fetch API) =====================
async function callApi(action, data = {}, method = 'GET') {
    document.getElementById('loading-overlay').classList.remove('hidden');
    try {
        let url = API_URL;
        let options = { method: method };

        if (method === 'GET') {
            const params = new URLSearchParams({ action: action, ...data });
            url += `?${params.toString()}`;
        } else {
            // POST ä½¿ç”¨ text/plain é¿å… CORS preflight (GAS ç‰¹æ€§)
            options.body = JSON.stringify({ action: action, ...data });
            options.headers = { "Content-Type": "text/plain;charset=utf-8" };
        }

        const response = await fetch(url, options);
        const result = await response.json();
        
        document.getElementById('loading-overlay').classList.add('hidden');
        return result;
    } catch (error) {
        document.getElementById('loading-overlay').classList.add('hidden');
        alert("é€£ç·šéŒ¯èª¤: " + error.message);
        return { success: false };
    }
}

// ===================== ç‹€æ…‹èˆ‡é‚è¼¯ =====================
let currentUser = null;
let cart = [];
let menuData = [];
let currentComboItem = null;

function init() {
    const savedUser = localStorage.getItem('u');
    const savedPass = localStorage.getItem('p');
    if(savedUser && savedPass) handleLogin(null, savedUser, savedPass);
    else toggleAuthMode(true);
}

function showMessage(msg) {
    const box = document.getElementById('message-box');
    box.textContent = msg;
    box.className = "p-3 rounded bg-blue-100 text-blue-700 text-center mb-4";
    box.classList.remove('hidden');
    setTimeout(() => box.classList.add('hidden'), 3000);
}

// --- ç™»å…¥/è¨»å†Š ---
function toggleAuthMode(isLogin = false) {
    const isReg = document.getElementById('login-form').classList.contains('hidden');
    const targetIsLogin = isLogin || isReg;
    document.getElementById('login-form').classList.toggle('hidden', !targetIsLogin);
    document.getElementById('register-form').classList.toggle('hidden', targetIsLogin);
    document.getElementById('auth-title').textContent = targetIsLogin ? 'ä½¿ç”¨è€…ç™»å…¥' : 'è¨»å†Šæ–°å¸³è™Ÿ';
    const link = document.getElementById('auth-toggle-link');
    link.textContent = targetIsLogin ? 'æ²’æœ‰å¸³è™Ÿï¼Ÿå»è¨»å†Š' : 'å·²æœ‰å¸³è™Ÿï¼Ÿå»ç™»å…¥';
    link.onclick = () => toggleAuthMode(!targetIsLogin);
}

async function handleLogin(e, u, p) {
    if(e) e.preventDefault();
    const user = u || document.querySelector('#login-form input[name="username"]').value;
    const pass = p || document.querySelector('#login-form input[name="password"]').value;
    const res = await callApi('login', { username: user, password: pass });
    
    if(res.success) {
        currentUser = res.username;
        localStorage.setItem('u', user); localStorage.setItem('p', pass);
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('order-section').classList.remove('hidden');
        document.getElementById('user-info-display').textContent = `Hi, ${user}`;
        if(res.isAdmin) document.getElementById('admin-entry-btn').classList.remove('hidden');
        loadMenu();
    } else {
        localStorage.removeItem('u'); localStorage.removeItem('p');
        showMessage(res.message);
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const user = document.querySelector('#register-form input[name="username"]').value;
    const pass = document.querySelector('#register-form input[name="password"]').value;
    const res = await callApi('register', { username: user, password: pass }, 'POST');
    if(res.success) {
        showMessage("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥");
        toggleAuthMode(true);
    } else {
        showMessage(res.message);
    }
}

function handleLogout() {
    currentUser = null; cart = [];
    localStorage.removeItem('u'); localStorage.removeItem('p');
    location.reload();
}

// --- èœå–®èˆ‡è³¼ç‰©è»Š ---
async function loadMenu() {
    const res = await callApi('getMenu');
    if(res.success) {
        menuData = res.data;
        renderMenu();
    }
}

function renderMenu() {
    const container = document.getElementById('menu-list');
    container.innerHTML = menuData.length ? '' : '<p class="text-center text-gray-500">ç„¡èœå–®</p>';
    menuData.forEach(item => {
        const btn = `<button onclick="addToCartInit('${item.id}')" class="bg-green-600 text-white w-8 h-8 rounded-full font-bold">+</button>`;
        container.innerHTML += `<div class="flex justify-between items-center p-3 border rounded shadow-sm bg-white">
            <div><div class="font-bold">${item.name}</div><div class="text-red-500">NT$ ${item.price}</div></div>
            ${btn}
        </div>`;
    });
}

function addToCartInit(id) {
    const item = menuData.find(i => i.id === id);
    if(item.type === 'å¥—é¤' && item.options && Object.keys(item.options).length > 0) {
        currentComboItem = item;
        openOptionModal(item);
    } else {
        addItemToCart(item, {}, 0);
    }
}

function openOptionModal(item) {
    const content = document.getElementById('modal-content');
    content.innerHTML = '';
    Object.keys(item.options).forEach((cat, idx) => {
        let opts = item.options[cat].map((opt, i) => {
            const name = Array.isArray(opt) ? opt[0] : opt;
            const price = Array.isArray(opt) ? opt[1] : 0;
            return `<label class="block p-2 border rounded mb-1"><input type="radio" name="opt-${cat}" value="${name}" data-p="${price}" ${i===0?'checked':''}> ${name} ${price?`(+${price})`:''}</label>`;
        }).join('');
        content.innerHTML += `<div class="font-bold mb-1">${cat}</div><div class="mb-3">${opts}</div>`;
    });
    document.getElementById('options-modal').classList.remove('hidden');
}

function addToCartFromModal() {
    let extra = 0;
    let selections = {};
    const content = document.getElementById('modal-content');
    content.querySelectorAll('input[type=radio]:checked').forEach(r => {
        selections[r.name.replace('opt-', '')] = r.value;
        extra += parseFloat(r.dataset.p || 0);
    });
    addItemToCart(currentComboItem, selections, extra);
    document.getElementById('options-modal').classList.add('hidden');
}

function addItemToCart(item, selections, extraPrice) {
    const finalPrice = item.price + extraPrice;
    const uid = `${item.id}-${JSON.stringify(selections)}`;
    const exist = cart.find(c => c.uid === uid);
    if(exist) exist.qty++;
    else cart.push({ uid: uid, name: item.name, price: finalPrice, type: item.type, qty: 1, selections: selections });
    renderCart();
}

function renderCart() {
    const list = document.getElementById('cart-list');
    let total = 0;
    list.innerHTML = cart.map((c, i) => {
        total += c.price * c.qty;
        const selStr = Object.values(c.selections).join(', ');
        return `<div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-1">
           <div class="text-sm"><b>${c.name}</b> x ${c.qty} <div class="text-xs text-gray-500">${selStr}</div></div>
           <div class="flex gap-2 items-center"><span class="text-red-600">NT$ ${c.price*c.qty}</span><button onclick="removeCart(${i})" class="text-gray-400">Ã—</button></div>
        </div>`;
    }).join('');
    document.getElementById('total-price').textContent = `NT$ ${total}`;
    const btn = document.getElementById('submit-button');
    btn.disabled = cart.length === 0;
    btn.textContent = cart.length ? "ç¢ºèªé»é¤" : "è«‹é¸æ“‡é¤é»";
}

function removeCart(idx) { cart.splice(idx, 1); renderCart(); }

async function submitOrder() {
    if(!cart.length) return;
    const total = parseFloat(document.getElementById('total-price').textContent.replace('NT$ ',''));
    const res = await callApi('submitOrder', { username: currentUser, total: total, items: cart }, 'POST');
    if(res.success) { showMessage("è¨‚å–®å·²é€å‡ºï¼"); cart = []; renderCart(); }
    else showMessage(res.message);
}

// --- æ­·å²ç´€éŒ„ ---
async function showHistoryPage() {
    document.getElementById('order-section').classList.add('hidden');
    document.getElementById('history-section').classList.remove('hidden');
    const res = await callApi('getHistory', { username: currentUser });
    const list = document.getElementById('history-list');
    if(res.success && res.history.length) {
        list.innerHTML = res.history.map(h => 
            `<div class="bg-white p-4 rounded shadow border"><div class="flex justify-between border-b pb-2 mb-2"><span class="text-gray-500 text-sm">${h.date}</span><span class="font-bold text-red-600">NT$ ${h.total}</span></div><pre class="text-sm text-gray-700 whitespace-pre-wrap font-sans">${h.items}</pre></div>`
        ).join('');
    } else {
        list.innerHTML = '<p class="text-center text-gray-500">ç„¡ç´€éŒ„</p>';
    }
}
function showOrderPage() { document.getElementById('history-section').classList.add('hidden'); document.getElementById('order-section').classList.remove('hidden'); }

// --- ç®¡ç†å“¡ ---
function showAdminPanel() { document.getElementById('admin-section').classList.remove('hidden'); switchAdminTab('orders'); }
function closeAdminPanel() { document.getElementById('admin-section').classList.add('hidden'); }

async function switchAdminTab(tab) {
    document.querySelectorAll('[id^="admin-tab-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');
    if(tab === 'orders') loadAdminOrders();
    if(tab === 'summary') loadAdminSummary();
    if(tab === 'menu') loadAdminMenu();
}

async function loadAdminOrders() {
    const res = await callApi('getAdminOrders');
    document.getElementById('admin-order-list').innerHTML = res.success ? res.data.map(o => 
        `<div class="bg-white p-3 rounded shadow mb-2 border">
            <div class="flex justify-between"><b>${o.user}</b> <button onclick="togglePay(${o.rowIndex}, ${o.paid})" class="text-xs px-2 rounded ${o.paid?'bg-green-500 text-white':'bg-gray-200'}">${o.paid?'å·²ä»˜':'æœªä»˜'}</button></div>
            <div class="text-sm bg-gray-50 p-2 my-1 rounded whitespace-pre-wrap">${o.items}</div>
            <div class="text-right text-red-600 font-bold">NT$ ${o.total}</div>
        </div>`
    ).join('') : 'è¼‰å…¥å¤±æ•—';
}
async function togglePay(idx, status) { await callApi('togglePayment', {rowIndex: idx, currentStatus: status}, 'POST'); loadAdminOrders(); }
function confirmResetOrders() {
    document.getElementById('system-modal').classList.remove('hidden');
    document.getElementById('system-modal-msg').textContent = "ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è¨‚å–®ï¼Ÿ";
    document.getElementById('sys-confirm').onclick = async () => {
        await callApi('resetOrders', {}, 'POST');
        document.getElementById('system-modal').classList.add('hidden');
        loadAdminOrders();
    };
}

async function loadAdminSummary() {
    const res = await callApi('getSummary');
    if(res.success) {
        document.getElementById('admin-grand-total').textContent = `NT$ ${res.grandTotal}`;
        document.getElementById('admin-summary-list').innerHTML = res.items.map(i => `<tr class="border-b"><td class="p-2">${i.name}</td><td class="p-2 text-right font-bold">${i.count}</td></tr>`).join('');
    }
}

async function captureSummary() {
    const content = document.getElementById('admin-summary-list').parentNode.cloneNode(true);
    const area = document.getElementById('summary-capture-area');
    area.innerHTML = `<h3 class="text-center font-bold mb-2">çµ±è¨ˆè¡¨</h3>`;
    area.appendChild(content);
    area.classList.remove('hidden');
    const canvas = await html2canvas(area);
    document.getElementById('preview-img').src = canvas.toDataURL();
    document.getElementById('image-preview-modal').classList.remove('hidden');
    area.classList.add('hidden');
}

// èœå–®ç·¨è¼¯
async function loadAdminMenu() {
    const res = await callApi('getMenu');
    document.getElementById('admin-menu-list').innerHTML = res.data.map(m => 
        `<div class="bg-white p-2 border rounded flex justify-between items-center mb-1">
            <span>${m.name} ($${m.price})</span>
            <div>
               <button onclick="editMenu('${m.id}','${m.name}','${m.price}','${m.type}')" class="text-blue-600 text-sm mr-2">ä¿®</button>
               <button onclick="delMenu('${m.id}')" class="text-red-600 text-sm">åˆª</button>
            </div>
        </div>`
    ).join('');
}
function editMenu(id, n, p, t) {
    document.getElementById('edit-item-id').value = id;
    document.getElementById('new-item-name').value = n;
    document.getElementById('new-item-price').value = p;
    document.getElementById('new-item-type').value = t;
}
function resetMenuForm() {
    document.getElementById('edit-item-id').value = '';
    document.getElementById('new-item-name').value = '';
    document.getElementById('new-item-price').value = '';
}
async function submitMenuForm() {
    const id = document.getElementById('edit-item-id').value;
    const data = {
        id: id,
        name: document.getElementById('new-item-name').value,
        price: document.getElementById('new-item-price').value,
        type: document.getElementById('new-item-type').value,
        options: JSON.stringify({}) 
    };
    await callApi(id ? 'updateMenuItem' : 'addMenuItem', data, 'POST');
    resetMenuForm();
    loadAdminMenu();
}
async function delMenu(id) {
    if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await callApi('deleteMenuItem', {id: id}, 'POST'); loadAdminMenu(); }
}

window.onload = init;
</script>
</body>
</html>